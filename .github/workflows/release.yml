name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build with Gradle
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: ./gradlew build -Pversion=${{ steps.version.outputs.VERSION }}

      - name: Run tests
        run: ./gradlew test

      - name: Build standalone JAR
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: ./gradlew :analyzer:executableJar -Pversion=${{ steps.version.outputs.VERSION }}

      - name: Build distributions
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: ./gradlew :analyzer:distZip :analyzer:distTar -Pversion=${{ steps.version.outputs.VERSION }}

      - name: List build artifacts before upload
        run: |
          echo "=== Analyzer libs directory ==="
          ls -la analyzer/build/libs/ || echo "No libs directory"
          echo ""
          echo "=== All JAR files ==="
          find analyzer/build -name "*.jar" -type f || echo "No JAR files found"
          echo ""
          echo "=== Analyzer distributions ==="
          ls -la analyzer/build/distributions/ || echo "No distributions directory"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            analyzer/build/libs/*.jar
            analyzer/build/distributions/*.zip
            analyzer/build/distributions/*.tar

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.VERSION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Debug - List all downloaded files
        run: |
          echo "=== Full artifact tree ==="
          find ./artifacts -ls
          echo ""
          echo "=== All JAR files ==="
          find ./artifacts -name "*.jar"
          echo ""
          echo "=== All files by type ==="
          find ./artifacts -type f | sort

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./artifacts/**/*-standalone.jar
            ./artifacts/**/*.zip
            ./artifacts/**/*.tar

  package-windows:
    name: Package for Windows
    needs: create-release
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Debug - List all artifacts
        shell: pwsh
        run: |
          Write-Host "=== PowerShell version ==="
          $PSVersionTable.PSVersion
          Write-Host ""
          Write-Host "=== Current directory ==="
          Get-Location
          Write-Host ""
          Write-Host "=== Does artifacts directory exist? ==="
          Test-Path ./artifacts
          Write-Host ""
          Write-Host "=== Artifacts directory contents (tree view) ==="
          if (Test-Path ./artifacts) {
            Get-ChildItem -Recurse -Force ./artifacts | Select-Object FullName, Length, Mode | Format-Table -AutoSize
          }
          Write-Host ""
          Write-Host "=== All JAR files ==="
          if (Test-Path ./artifacts) {
            Get-ChildItem -Recurse -Filter "*.jar" ./artifacts | Select-Object FullName, Length
          }

      - name: Find and copy JAR
        shell: pwsh
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          
          Write-Host "Looking for standalone JAR..."
          $jar = Get-ChildItem -Recurse -Filter "*standalone.jar" -File ./artifacts -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if (-not $jar) {
            Write-Host "Standalone JAR not found. Trying alternative patterns..."
            $jar = Get-ChildItem -Recurse -Filter "*analyzer*.jar" -File ./artifacts -ErrorAction SilentlyContinue | 
                   Where-Object { $_.Name -match "standalone" } | 
                   Select-Object -First 1
          }
          
          if (-not $jar) {
            Write-Host "Still not found. Looking for any analyzer JAR..."
            $jar = Get-ChildItem -Recurse -Filter "*analyzer*.jar" -File ./artifacts -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          
          if ($jar) {
            Write-Host "Found JAR: $($jar.FullName)"
            Write-Host "JAR size: $($jar.Length) bytes"
          
            # Create directory and copy
            New-Item -ItemType Directory -Force -Path ".\package\windows\bin" | Out-Null
            Copy-Item $jar.FullName ".\package\windows\bin\seemake.jar"
            Write-Host "JAR copied successfully"
          } else {
            Write-Error "Could not find any suitable JAR file!"
            exit 1
          }

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create Windows Installer
        shell: pwsh
        run: |
          $version = "${{ needs.create-release.outputs.version }}"
          
          # Create installer directory
          New-Item -ItemType Directory -Force -Path ".\package\windows\installer"
          
          # Create batch script
          @"
  @echo off
  java -jar "%~dp0seemake.jar" %*
  "@ | Out-File -FilePath ".\package\windows\bin\seemake.bat" -Encoding ascii
  
  # Create WiX source
  @"
  <?xml version="1.0" encoding="UTF-8"?>
  <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="Seemake" Language="1033" Version="$version.0"
  Manufacturer="Seemake" UpgradeCode="12345678-1234-1234-1234-123456789012">
  <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
  <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
  <MediaTemplate EmbedCab="yes" />
  
  <Feature Id="ProductFeature" Title="Seemake" Level="1">
  <ComponentGroupRef Id="ProductComponents" />
  </Feature>
  
  <Directory Id="TARGETDIR" Name="SourceDir">
  <Directory Id="ProgramFilesFolder">
  <Directory Id="INSTALLFOLDER" Name="Seemake" />
  </Directory>
  </Directory>
  
  <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
  <Component Id="SeemakeJar" Guid="*">
  <File Id="SeemakeJar" Source=".\package\windows\bin\seemake.jar" KeyPath="yes" />
  </Component>
  <Component Id="SeemakeBat" Guid="*">
  <File Id="SeemakeBat" Source=".\package\windows\bin\seemake.bat" KeyPath="yes" />
  <Environment Id="PATH" Name="PATH" Value="[INSTALLFOLDER]" Permanent="no" Part="last" Action="set" System="yes" />
  </Component>
  </ComponentGroup>
  </Product>
  </Wix>
  "@ | Out-File -FilePath ".\package\windows\installer\seemake.wxs" -Encoding utf8
  
  # Build installer
  candle ".\package\windows\installer\seemake.wxs" -out ".\package\windows\installer\seemake.wixobj"
  light ".\package\windows\installer\seemake.wixobj" -out ".\package\windows\seemake-$version-windows.msi"

  - name: Upload Windows Installer
    uses: softprops/action-gh-release@v1
    with:
      tag_name: v${{ needs.create-release.outputs.version }}
      files: ./package/windows/seemake-${{ needs.create-release.outputs.version }}-windows.msi

package-linux:
  name: Package for Linux
  needs: create-release
  runs-on: ubuntu-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./artifacts

    - name: Debug - List artifacts
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Artifacts directory tree ==="
        ls -laR ./artifacts
        echo ""
        echo "=== All files ==="
        find ./artifacts -type f -ls
        echo ""
        echo "=== All JAR files ==="
        find ./artifacts -name "*.jar" -type f

    - name: Find standalone JAR
      id: find_jar
      run: |
        echo "Looking for standalone JAR..."
        JAR_PATH=$(find ./artifacts -name "*standalone.jar" -type f | head -n 1)
        
        if [ -z "$JAR_PATH" ]; then
          echo "Standalone JAR not found. Trying analyzer pattern..."
          JAR_PATH=$(find ./artifacts -name "*analyzer*.jar" -type f | grep standalone | head -n 1)
        fi
        
        if [ -z "$JAR_PATH" ]; then
          echo "Still not found. Looking for any analyzer JAR..."
          JAR_PATH=$(find ./artifacts -name "*analyzer*.jar" -type f | head -n 1)
        fi
        
        if [ -z "$JAR_PATH" ]; then
          echo "Error: Could not find any suitable JAR file!"
          echo "Available files:"
          find ./artifacts -type f
          exit 1
        fi
        
        echo "Found JAR at: $JAR_PATH"
        ls -lh "$JAR_PATH"
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_OUTPUT

    - name: Create DEB package
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        JAR_PATH="${{ steps.find_jar.outputs.JAR_PATH }}"
        
        # Create directory structure
        mkdir -p package/deb/seemake_${VERSION}/DEBIAN
        mkdir -p package/deb/seemake_${VERSION}/usr/bin
        mkdir -p package/deb/seemake_${VERSION}/usr/share/seemake
        mkdir -p package/deb/seemake_${VERSION}/usr/share/doc/seemake
        
        # Copy JAR
        cp "$JAR_PATH" package/deb/seemake_${VERSION}/usr/share/seemake/seemake.jar
        
        # Create launcher script
        cat > package/deb/seemake_${VERSION}/usr/bin/seemake << 'EOF'
  #!/bin/bash
  exec java -jar /usr/share/seemake/seemake.jar "$@"
  EOF
  chmod +x package/deb/seemake_${VERSION}/usr/bin/seemake
  
  # Create control file
  cat > package/deb/seemake_${VERSION}/DEBIAN/control << EOF
Package: seemake
Version: ${VERSION}
Section: devel
Priority: optional
Architecture: all
Depends: openjdk-21-jre | java21-runtime
Maintainer: Seemake Team <your-email@example.com>
Description: CMake analyzer for Kotlin/Java
  Seemake is a powerful CMake analyzer written in Kotlin/Java using ANTLR.
  It provides comprehensive analysis capabilities for CMake projects.
  EOF
  
  # Create copyright file
  cat > package/deb/seemake_${VERSION}/usr/share/doc/seemake/copyright << EOF
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: seemake
Source: https://github.com/thisismeamir/Seemake

Files: *
Copyright: 2024 Seemake Team
License: Apache-2.0
  EOF
  
  # Build DEB package
  dpkg-deb --build package/deb/seemake_${VERSION}
  mv package/deb/seemake_${VERSION}.deb package/seemake-${VERSION}-amd64.deb

  - name: Create RPM package
    run: |
      VERSION="${{ needs.create-release.outputs.version }}"
      JAR_PATH="${{ steps.find_jar.outputs.JAR_PATH }}"
      
      # Install rpmbuild
      sudo apt-get update
      sudo apt-get install -y rpm
      
      # Create directory structure
      mkdir -p package/rpm/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
      mkdir -p package/rpm/BUILD/seemake-${VERSION}/usr/bin
      mkdir -p package/rpm/BUILD/seemake-${VERSION}/usr/share/seemake
      
      # Copy JAR
      cp "$JAR_PATH" package/rpm/BUILD/seemake-${VERSION}/usr/share/seemake/seemake.jar
      
      # Create launcher script
      cat > package/rpm/BUILD/seemake-${VERSION}/usr/bin/seemake << 'EOF'
    #!/bin/bash
    exec java -jar /usr/share/seemake/seemake.jar "$@"
    EOF
    chmod +x package/rpm/BUILD/seemake-${VERSION}/usr/bin/seemake
    
    # Create spec file
    cat > package/rpm/SPECS/seemake.spec << EOF
Name:           seemake
Version:        ${VERSION}
Release:        1%{?dist}
Summary:        CMake analyzer for Kotlin/Java
License:        Apache-2.0
URL:            https://github.com/thisismeamir/Seemake
Requires:       java-21-openjdk
  
  %description
  Seemake is a powerful CMake analyzer written in Kotlin/Java using ANTLR.
  It provides comprehensive analysis capabilities for CMake projects.
  
  %install
  mkdir -p %{buildroot}/usr/bin
  mkdir -p %{buildroot}/usr/share/seemake
  cp %{_topdir}/BUILD/seemake-${VERSION}/usr/share/seemake/seemake.jar %{buildroot}/usr/share/seemake/
  cp %{_topdir}/BUILD/seemake-${VERSION}/usr/bin/seemake %{buildroot}/usr/bin/
  
  %files
  /usr/bin/seemake
  /usr/share/seemake/seemake.jar
  
  %changelog
  * $(date "+%a %b %d %Y") Seemake Team <your-email@example.com> - ${VERSION}-1
  - Release ${VERSION}
    EOF
    
    # Build RPM
    rpmbuild --define "_topdir $(pwd)/package/rpm" -bb package/rpm/SPECS/seemake.spec
    cp package/rpm/RPMS/*/seemake-*.rpm package/seemake-${VERSION}-1.x86_64.rpm
- name: Upload Linux packages
  uses: softprops/action-gh-release@v1
  with:
    tag_name: v${{ needs.create-release.outputs.version }}
    files: |
      ./package/seemake-${{ needs.create-release.outputs.version }}-amd64.deb
      ./package/seemake-${{ needs.create-release.outputs.version }}-1.x86_64.rpm

package-macos:
  name: Package for macOS
  needs: create-release
  runs-on: macos-latest

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./artifacts

    - name: Debug - List artifacts
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Artifacts directory tree ==="
        ls -laR ./artifacts
        echo ""
        echo "=== All files ==="
        find ./artifacts -type f -ls
        echo ""
        echo "=== All JAR files ==="
        find ./artifacts -name "*.jar" -type f

    - name: Find standalone JAR
      id: find_jar
      run: |
        echo "Looking for standalone JAR..."
        JAR_PATH=$(find ./artifacts -name "*standalone.jar" -type f | head -n 1)
        
        if [ -z "$JAR_PATH" ]; then
          echo "Standalone JAR not found. Trying analyzer pattern..."
          JAR_PATH=$(find ./artifacts -name "*analyzer*.jar" -type f | grep standalone | head -n 1)
        fi
        
        if [ -z "$JAR_PATH" ]; then
          echo "Still not found. Looking for any analyzer JAR..."
          JAR_PATH=$(find ./artifacts -name "*analyzer*.jar" -type f | head -n 1)
        fi
        
        if [ -z "$JAR_PATH" ]; then
          echo "Error: Could not find any suitable JAR file!"
          echo "Available files:"
          find ./artifacts -type f
          exit 1
        fi
        
        echo "Found JAR at: $JAR_PATH"
        ls -lh "$JAR_PATH"
        echo "JAR_PATH=$JAR_PATH" >> $GITHUB_OUTPUT

    - name: Create macOS package
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        JAR_PATH="${{ steps.find_jar.outputs.JAR_PATH }}"
        
        # Create app bundle structure
        mkdir -p package/macos/Seemake.app/Contents/{MacOS,Resources}
        
        # Copy JAR
        cp "$JAR_PATH" package/macos/Seemake.app/Contents/Resources/seemake.jar
        
        # Create launcher script
        cat > package/macos/Seemake.app/Contents/MacOS/seemake << 'EOF'
  #!/bin/bash
  DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
  exec java -jar "$DIR/../Resources/seemake.jar" "$@"
  EOF
  chmod +x package/macos/Seemake.app/Contents/MacOS/seemake
  
  # Create Info.plist
  cat > package/macos/Seemake.app/Contents/Info.plist << EOF
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
  <key>CFBundleDevelopmentRegion</key>
  <string>English</string>
  <key>CFBundleExecutable</key>
  <string>seemake</string>
  <key>CFBundleIdentifier</key>
  <string>io.github.thisismeamir.seemake</string>
  <key>CFBundleInfoDictionaryVersion</key>
  <string>6.0</string>
  <key>CFBundleName</key>
  <string>Seemake</string>
  <key>CFBundlePackageType</key>
  <string>APPL</string>
  <key>CFBundleShortVersionString</key>
  <string>${VERSION}</string>
  <key>CFBundleVersion</key>
  <string>${VERSION}</string>
  <key>LSMinimumSystemVersion</key>
  <string>10.15</string>
  </dict>
  </plist>
  EOF
  
  # Create Homebrew formula
  mkdir -p package/macos/homebrew
  cat > package/macos/homebrew/seemake.rb << EOF
  class Seemake < Formula
  desc "CMake analyzer for Kotlin/Java"
  homepage "https://github.com/thisismeamir/Seemake"
  url "https://github.com/thisismeamir/Seemake/releases/download/v${VERSION}/analyzer-${VERSION}-standalone.jar"
  version "${VERSION}"
  sha256 :no_check

  depends_on "openjdk@21"

  def install
  libexec.install "analyzer-${VERSION}-standalone.jar" => "seemake.jar"
  bin.write_jar_script libexec/"seemake.jar", "seemake"
  end

  test do
  system "#{bin}/seemake", "--version"
  end
  end
  EOF
  
  # Create DMG
  hdiutil create -volname "Seemake" -srcfolder package/macos/Seemake.app \
  -ov -format UDZO package/seemake-${VERSION}-macos.dmg
  
  # Create tarball for command-line installation
  cd package/macos
  tar -czf ../seemake-${VERSION}-macos.tar.gz Seemake.app homebrew

  - name: Upload macOS packages
    uses: softprops/action-gh-release@v1
    with:
      tag_name: v${{ needs.create-release.outputs.version }}
      files: |
        ./package/seemake-${{ needs.create-release.outputs.version }}-macos.dmg
        ./package/seemake-${{ needs.create-release.outputs.version }}-macos.tar.gz

publish-jitpack:
  name: Trigger JitPack build
  needs: create-release
  runs-on: ubuntu-latest

  steps:
    - name: Trigger JitPack
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        curl "https://jitpack.io/com/github/thisismeamir/Seemake/${VERSION}/build.log"